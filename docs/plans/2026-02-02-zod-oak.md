# Add Oak HTTP adapter + Zod validation across server and sync helpers

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds.

This repository includes `.agent/PLANS.md` at the repo root. This document must be maintained in accordance with that file.

## Purpose / Big Picture

After this change, the backend HTTP adapter will be built on Oak instead of the hand-rolled router, and both the adapter and the RealWorld sync helpers will use Zod for input validation. A user can start the server and observe the same HTTP API behavior as before, but request parsing and validation will be simpler, more consistent, and easier to extend. The practical proof is that `deno test` still passes and basic HTTP calls (like creating a user and listing articles) behave the same while invalid JSON returns a structured 400 response.

## Progress

- [x] (2026-02-02 18:13Z) Draft ExecPlan for Oak adapter and Zod validation.
- [x] (2026-02-02 18:33Z) Implement Oak-based HTTP adapter in `server.ts`, retaining `handleRequest` for tests.
- [x] (2026-02-02 18:33Z) Add Zod-based input parsing helpers and replace `syncs/realworld/helpers.ts` utilities.
- [x] (2026-02-02 18:33Z) Add Zod validation for server request parsing (query/body/params), with consistent errors.
- [x] (2026-02-02 18:33Z) Update tests or add new coverage for malformed JSON and validation errors.
- [x] (2026-02-02 18:33Z) Run relevant Deno tests and document results here.
- [x] (2026-02-02 18:38Z) Add per-endpoint Zod schemas in `server.ts` for route-specific validation.
- [x] (2026-02-02 18:38Z) Re-run Deno test suite after per-endpoint validation changes.

## Surprises & Discoveries

- Observation: Oak 17 request bodies do not expose `body.has()`, so JSON parsing must rely on `body.type` and `body.json()` instead.
  Evidence: `{"error":"body.has is not a function"}` when calling `handleRequest` with JSON.

## Decision Log

- Decision: Use Oak as the HTTP framework and Zod for validation across server and sync helpers.
  Rationale: User preference and improved developer ergonomics compared to custom parsing.
  Date/Author: 2026-02-02 / Codex
- Decision: Use `body.type` plus `body.json()`/`body.text()` for Oak JSON parsing instead of `body.has()`.
  Rationale: Oak 17 Body does not expose `has()`, causing runtime errors.
  Date/Author: 2026-02-02 / Codex
- Decision: Validate merged request inputs using per-endpoint Zod schemas that are permissive (`passthrough`) but enforce required fields.
  Rationale: Provide clear early validation without stripping extra data or diverging from sync-side logic.
  Date/Author: 2026-02-02 / Codex

## Outcomes & Retrospective

The HTTP adapter now uses Oak and Zod-backed parsing for inputs, with per-endpoint schemas, and RealWorld sync helpers use Zod for validation utilities. Tests cover malformed JSON and still pass. The change improves request parsing consistency while preserving API behavior.

## Context and Orientation

The backend HTTP adapter is currently in `server.ts` and uses a custom router plus manual JSON parsing. It calls `createRealWorldApp()` from `realworld_app.ts`, then triggers `API.request` and reads results from `API._get`. The RealWorld sync helpers in `syncs/realworld/helpers.ts` include ad-hoc parsing functions (`asRecord`, `getString`, `getStringArray`, etc.) that are used to validate request inputs inside syncs. The repository runs on Deno; server code imports from Deno std libraries and local TypeScript modules. The web frontend is in `apps/web` and is not part of this backend change.

Key files:
- `server.ts`: HTTP adapter and route matching logic.
- `server.test.ts`: Deno test that exercises the HTTP adapter via `handleRequest`.
- `syncs/realworld/helpers.ts`: input parsing helpers used by syncs.
- `syncs/realworld/*.ts`: RealWorld syncs that call the helpers.

Oak is a Deno HTTP framework (router + middleware). Zod is a schema validation library that can parse and validate inputs and return typed values. In this repo, Zod will be used to parse and validate request payloads and helper inputs, returning safe primitives or structured errors.

## Plan of Work

First, replace the custom router in `server.ts` with Oak. Create an Oak `Application` and `Router` that define the same routes as before. Add middleware for CORS and JSON parsing. Implement a handler that merges query parameters, path params, and JSON body into a single `input` object, then calls the same `API.request` flow and returns JSON responses. Keep a `handleRequest(request: Request)` function for tests by using Oak’s `app.handle`/`app.fetch` capability so `server.test.ts` can remain close to current usage. Preserve existing HTTP status semantics and error responses.

Second, introduce Zod in the backend code. Add a small validation module (either in `server.ts` or a new `server/validation.ts`) that uses Zod to parse query params, path params, and JSON bodies. Replace `readJsonBody` to use Zod’s object parsing, returning a 400 error when the request body is not a JSON object. Use Zod for guardrails on query param values and for the merged input shape.

Third, refactor `syncs/realworld/helpers.ts` to use Zod instead of manual type checks. Keep the public helper function names if possible to minimize changes in sync files, but implement them using Zod schemas (e.g., `z.string().trim().min(1)` for `getString`, `z.array(z.string())` with trimming for `getStringArray`, and `z.record(z.unknown())` for `asRecord`). Update any call sites if Zod’s behavior requires slight changes.

Fourth, update tests. Ensure `server.test.ts` still passes. Add a new test for invalid JSON or invalid body shape (non-object) and confirm it returns a 400 with the structured error. If any helper behavior changes, add a targeted sync test or unit test to confirm the expected parsing behavior.

## Concrete Steps

1) Inspect Oak and Zod import options suitable for Deno. Prefer JSR or npm specifiers compatible with this repo. Record the chosen import paths.
2) Update `server.ts` to:
   - Create Oak `Application` and `Router`.
   - Define routes matching the current `routes` array.
   - Add middleware for CORS and JSON handling.
   - Implement `handleRequest` using Oak’s app handler so tests can call it.
3) Introduce Zod parsing helpers for server request parsing, returning consistent errors for non-object JSON.
4) Refactor `syncs/realworld/helpers.ts` to use Zod schemas while keeping current signatures.
5) Update/extend tests in `server.test.ts` (and add a helper test if needed).
6) Run Deno tests:
   - From repo root: `deno test`.
   - If needed, `deno test server.test.ts` to isolate adapter behavior.
   Record results in `Progress` and `Artifacts and Notes`.

## Validation and Acceptance

Acceptance is:
- Running `deno test` passes with the same or expanded test coverage.
- Starting the server with `deno run -A server.ts` still responds to existing endpoints.
- Sending invalid JSON body returns HTTP 400 with a JSON error payload.
- Core API flows (e.g., `POST /users`, `POST /gitless/init`) behave as in `server.test.ts`.

## Idempotence and Recovery

All changes are additive or refactors that can be re-run without side effects. If the Oak refactor fails, revert `server.ts` to the custom router version and rerun tests. If Zod parsing is too strict, loosen schemas to accept broader inputs while preserving string trimming logic.

## Artifacts and Notes

Expected test transcript excerpt (example):

    deno test
    running 1 test from server.test.ts
    ok | http adapter: realworld + gitless
    running 10 tests from concepts/test/... (example)
    ok | all tests

Actual test transcript excerpt:

    deno test
    ok | 20 passed | 0 failed (557ms)

## Interfaces and Dependencies

- Add Oak (Deno HTTP framework) and Zod (validation) as runtime dependencies for the backend.
- `server.ts` must export `handleRequest(request: Request): Promise<Response>` and preserve its behavior.
- `syncs/realworld/helpers.ts` must continue exporting helper functions with the same names to avoid widespread refactors.

Plan update note: Updated progress, decisions, and outcomes after adding per-endpoint Zod schemas and rerunning tests on 2026-02-02.
